---
import Image from "astro/components/Image.astro"
import bg_image from "../assets/theme-images/hero-image.jpg"

const { newsletter } = Astro.props

---

<aside class="@container bs-container bs-mt-lg text-center" id="newsletter">

  <!-- Wrapper -->
  <div class="p-6 md:py-16 relative rounded-xl overflow-hidden flex justify-center isolate w-full h-full">

    <!-- BG image -->
    <Image src={ bg_image } alt="" format="avif" height={1080} width={1920} class="rounded-xl overflow-hidden w-full h-full object-cover object-left absolute inset-0 opacity-50" />

    <!-- Content -->
    <div class="z-10 p-6 md:p-10 lg:p-20 rounded-xl md:max-w-lg flex flex-col gap-6 bg-bs-surface-0/95 h-full">

      <!-- Title -->
      <h2 class="bs-h2" set:html={ newsletter.title } />

      <!-- Intro -->
      <div class="bs-body-text flex-grow" set:html={ newsletter.content } />

      <!-- Form -->
      <form id="newsletter-form" class="flex gap-4 flex-col">

        <label class="sr-only" for="nl-name">Tu nombre</label>
        <input
          id="nl-name"
          name="name"
          class="border-2 rounded-lg bg-bs-surface-0 border-bs-surface-3 form-input px-4 py-3"
          placeholder="Jhon Doe">

        <label class="sr-only" for="nl-phone">Tu n√∫mero de celular</label>
        <input
          id="nl-phone"
          name="phone"
          type="tel"
          class="border-2 rounded-lg bg-bs-surface-0 border-bs-surface-3 form-input px-4 py-3"
          placeholder="69405752">

        <input id="newsletter-submit" type="submit" value={ newsletter.cta } class="bs-btn form-input px-4 py-3">

      </form>

    </div>

  </div>

  <!-- Toast Notification -->
  <div id="toast-notification" class="fixed bottom-5 right-5 z-50 px-4 py-3 rounded-lg text-white bg-green-500 transition-all duration-300 opacity-0 translate-y-4 pointer-events-none">
    <span id="toast-message"></span>
  </div>

</aside>

<script>
  const form = document.getElementById('newsletter-form') as HTMLFormElement;
  const submitButton = document.getElementById('newsletter-submit') as HTMLInputElement;
  const toast = document.getElementById('toast-notification') as HTMLDivElement;
  const toastMessage = document.getElementById('toast-message') as HTMLSpanElement;
  let toastTimeout: number;

  // --- Form Submission Logic ---
  form.addEventListener('submit', async (event) => {
    event.preventDefault();

    const originalButtonText = submitButton.value;
    submitButton.value = 'Enviando...';
    submitButton.disabled = true;

    const formData = new FormData(form);
    const name = (formData.get('name') as string)?.trim();
    const phone = (formData.get('phone') as string)?.trim();

    // Validations
    if (name.length <= 2) {
      showToast('Tu nombre debe tener m√°s de 2 caracteres.', true);
      submitButton.value = originalButtonText;
      submitButton.disabled = false;
      return;
    }
    if (!/^\d{8}$/.test(phone)) {
      showToast('Tu n√∫mero de celular debe tener 8 d√≠gitos.', true);
      submitButton.value = originalButtonText;
      submitButton.disabled = false;
      return;
    }

    const text = `la persona *${name}* con el numero *${phone}* quiere recibir novedades sobre la empresa`;

    try {
      const response = await fetch('https://whatsapp-api.desarrollocreativo.dev/send?id=desarrollo-creativo', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          phone: '59175199157',
          text: text,
        }),
      });

      if (response.ok) {
        // Show success message to the user on the website
        showToast('¬°Gracias por suscribirte! Pronto recibir√°s novedades.');

        // Prepare and send the welcome message to the new subscriber
        const welcomeMessage = `¬°Hola, *${name}*! üëã ¬°Bienvenido/a a la comunidad de *Desarrollo Creativo*! üöÄ A partir de ahora, recibir√°s nuestras √∫ltimas novedades y ofertas especiales. ¬°Gracias por unirte! ‚ú®`;
        await fetch('https://whatsapp-api.desarrollocreativo.dev/send?id=desarrollo-creativo', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            phone: `591${phone}`, // Send to the user's number (prefixed with country code)
            text: welcomeMessage,
          }),
        });

        form.reset();
      } else {
        showToast('Hubo un error al enviar tu solicitud. Por favor, int√©ntalo de nuevo.', true);
      }
    } catch (error) {
      showToast('Hubo un error de red. Por favor, revisa tu conexi√≥n e int√©ntalo de nuevo.', true);
    } finally {
      submitButton.value = originalButtonText;
      submitButton.disabled = false;
    }
  });

  // --- Toast Notification Logic ---
  function showToast(message: string, isError = false) {
    clearTimeout(toastTimeout);

    toastMessage.textContent = message;

    // Set color based on success or error
    toast.classList.toggle('bg-red-500', isError);
    toast.classList.toggle('bg-green-500', !isError);

    // Show toast
    toast.classList.remove('opacity-0', 'translate-y-4');
    toast.classList.add('opacity-100', 'translate-y-0');

    // Hide toast after 3 seconds
    toastTimeout = window.setTimeout(() => {
      toast.classList.remove('opacity-100', 'translate-y-0');
      toast.classList.add('opacity-0', 'translate-y-4');
    }, 3000);
  }
</script>
